---
import { Icon } from "astro-icon/components";

const { locationUrl, locationName, ...props } = Astro.props;
const mapId = `map-${Math.random().toString(36).substring(2, 9)}`;
---

<a 
  id={mapId}
  class="inline-flex items-center gap-1 font-medium px-2.5 py-1 border-2 border-black rounded map-link" 
  href={locationUrl}
  target="_blank" 
  rel="noopener noreferrer"
  data-location={locationUrl}
  {...props}
>
  <Icon name="tabler:map-pin" size="25px" title="map" class="map-icon" />
  {locationName}
</a>

<script is:inline>
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.map-link').forEach(link => {
    // Check if iOS
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                 (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    
    const locationUrl = link.dataset.location;
    
    if (!locationUrl) return; // Skip if no URL
    
    // Handle both short (maps.app.goo.gl) and long (google.com/maps) URLs
    if (isIOS) {
      if (locationUrl.includes('maps.app.goo.gl')) {
        // Convert short Google URL to Apple Maps
        link.href = `https://maps.apple.com/?q=${encodeURIComponent(locationUrl)}`;
      } else if (locationUrl.includes('google.com/maps')) {
        // Convert long Google URL to Apple Maps
        link.href = locationUrl
          .replace('https://www.google.com/maps', 'https://maps.apple.com')
          .replace('?q=', '?ll=');
      }
      link.querySelector('.map-icon').setAttribute('name', 'tabler:navigation');
    }
  });
});
</script>